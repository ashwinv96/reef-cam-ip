{% for camera_id, config in cameras.items() %}
<h2>Camera {{ loop.index }}</h2>
<img src="/video_feed/{{ camera_id }}" width="640"><br>

<!-- Snapshot Button -->
<form action="/snapshot/{{ camera_id }}"><button type="submit">ðŸ“¸ Snapshot {{ camera_id }}</button></form>

<!-- Timelapse Enable Toggle -->
<button id="timelapse-toggle-{{ camera_id }}" onclick="toggleTimelapse('{{ camera_id }}')">Enable Timelapse</button>
<span id="timelapse-status-{{ camera_id }}" style="margin-left: 10px; color: gray;"></span>

<script>
    function toggleTimelapse(cameraId) {
        const button = document.getElementById(`timelapse-toggle-${cameraId}`);
        const isEnabled = button.textContent.includes("Disable");
        fetch(`/toggle_timelapse/${cameraId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ enable: !isEnabled })
        }).then(() => {
            button.textContent = isEnabled ? "Enable Timelapse" : "Disable Timelapse";
        });
    }

    function checkStatus(cameraId) {
    fetch(`/status/${cameraId}`)
        .then(res => res.json())
        .then(data => {
            const button = document.getElementById(`timelapse-toggle-${cameraId}`);
            const status = document.getElementById(`timelapse-status-${cameraId}`);
            if (data.enabled) {
                button.textContent = "Disable Timelapse";
                if (data.seconds_left !== null) {
                    status.textContent = `â³ Timelapse running... (${data.seconds_left}s left for next video)`;
                } else {
                    status.textContent = "â³ Timelapse running...";
                }
            } else {
                button.textContent = "Enable Timelapse";
                status.textContent = "Timelapse disabled";
            }
        });
}

    function startPolling() {
        setInterval(() => {
            {% for camera_id in cameras %}
            checkStatus("{{ camera_id }}");
            {% endfor %}
        }, 5000); // poll every 5s
    }

    window.onload = startPolling;
</script>
{% endfor %}